name: Deploy to Toolforge

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Get the code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Node to build Vue
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. Build the Frontend
      - name: Build Vue App
        env:
          VITE_BACKEND_URL: ${{ secrets.VITE_BACKEND_URL }}

        run: |
          echo "Building Frontend..."
          cd frontend  
          npm install
          npm run build
          echo "Frontend Built!"
      # 4. Setup SSH Agent 
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.TOOLFORGE_SSH_KEY }}

      - name: Add Known Hosts
        run: ssh-keyscan login.toolforge.org >> ~/.ssh/known_hosts

      # 5. Deploy (SCP + SSH)
      - name: Deploy to Toolforge
        env:
          SSH_USER: ${{ secrets.TOOLFORGE_USER }}
          TOOL_NAME: ${{ secrets.TOOL_NAME }}
          HOST: login.toolforge.org
        run: |
          set -e
          
          echo "Clearing frontend-build on Toolforge"
          ssh "$SSH_USER@$HOST" "rm -rf /data/project/$TOOL_NAME/frontend-build/*"
          
          echo "Uploading frontend build"
          scp -r frontend/dist/* "$SSH_USER@$HOST:/data/project/$TOOL_NAME/frontend-build/"
          
          echo "Verifying upload"
          ssh "$SSH_USER@$HOST" "ls -la /data/project/$TOOL_NAME/frontend-build/"
          
          echo "Setting permissions"
          ssh "$SSH_USER@$HOST" "chmod -R g+rwX /data/project/$TOOL_NAME/frontend-build"
          
          echo "Deploying on Toolforge"
          ssh -tt "$SSH_USER@$HOST" "become $TOOL_NAME bash -c 'set -ex && cd /data/project/$TOOL_NAME/www/python/src && git fetch origin && git reset --hard origin/main && rm -rf /data/project/$TOOL_NAME/www/python/static && mkdir -p /data/project/$TOOL_NAME/www/python/static && rsync -av --delete /data/project/$TOOL_NAME/frontend-build/ /data/project/$TOOL_NAME/www/python/static/ && ls -la /data/project/$TOOL_NAME/www/python/static/ && webservice python3.13 restart'"
