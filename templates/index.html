<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title or 'Wikimedia Communities Activity Logs' }}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
        }

        .sidebar-transition {
            transition: all 0.3s ease;
            background: white;
            border-right: 1px solid #e1e5e9;
        }

        .sidebar-collapsed {
            width: 0;
            padding: 0;
            margin: 0;
        }

        .sidebar-content {
            width: 18rem;
            transition: all 0.3s ease;
            padding: 1.5rem;
            padding-top: 4rem;
        }

        .sidebar-collapsed .sidebar-content {
            transform: translateX(-100%);
            opacity: 0;
        }

        .toggle-button {
            transition: all 0.3s ease;
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .toggle-button:hover {
            background: #f8f9fa;
            border-color: #0645ad;
        }

        .toggle-button.collapsed {
            left: 0.5rem;
        }

        /* Wikimedia-style form elements */
        .form-input,
        .form-button {
            border: 1px solid #a2a9b1;
            border-radius: 2px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            border-color: #0645ad;
            box-shadow: 0 0 0 1px #0645ad;
            outline: none;
        }

        .form-button {
            background: #0645ad;
            color: white;
            font-weight: 500;
            cursor: pointer;
        }

        .form-button:hover {
            background: #0b4ba0;
        }

        .form-button:disabled {
            background: #c8ccd1;
            cursor: not-allowed;
        }

        #dateSlider {
            user-select: none;
        }

        #sliderTrack {
            transition: all 0.1s ease;
        }

        #startHandle,
        #endHandle {
            transform: translateX(-50%);
            transition: all 0.1s ease;
        }

        /* Wikimedia-style project selector */
        .project-selector-input-container {
            position: relative;
        }

        .project-selector-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #a2a9b1;
            border-top: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 50;
            max-height: 300px;
            overflow-y: auto;
            animation: dropdownFadeIn 0.15s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .project-selector-list {
            padding: 0.5rem 0;
        }

        .project-selector-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.15s ease;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .project-selector-item:hover,
        .project-selector-item.highlighted {
            background-color: #eaf3ff;
            border-left-color: #0645ad;
        }

        .project-selector-item.selected {
            background-color: #eaf3ff;
            border-left-color: #0645ad;
        }

        .project-selector-item-main {
            flex: 1;
            min-width: 0;
        }

        .project-selector-item-title {
            font-weight: 500;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-selector-item-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.125rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-selector-arrow {
            margin-left: 0.5rem;
            color: #9ca3af;
            transition: transform 0.15s ease;
        }

        .project-selector-item:hover .project-selector-arrow {
            transform: translateX(2px);
        }

        .project-selector-separator {
            height: 1px;
            background-color: #e5e7eb;
            margin: 0.5rem 0;
        }

        .project-selector-back {
            padding: 0.75rem 1rem;
            cursor: pointer;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            align-items: center;
            font-weight: 500;
            color: #0645ad;
            transition: background-color 0.15s ease;
        }

        .project-selector-back:hover {
            background-color: #eaf3ff;
        }

        .project-selector-back-arrow {
            margin-right: 0.5rem;
            transition: transform 0.15s ease;
        }

        .project-selector-back:hover .project-selector-back-arrow {
            transform: translateX(-2px);
        }

        .project-selector-loading {
            padding: 2rem 1rem;
            text-align: center;
            color: #6b7280;
        }

        .project-selector-no-results {
            padding: 2rem 1rem;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }

        /* Wikimedia-style content containers */
        .content-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eaecf0;
        }

        .page-title {
            color: #222;
            font-weight: 400;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #72777d;
            font-size: 1rem;
        }

        /* Wikimedia-style cards */
        .wiki-card {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 2px;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .wiki-card-header {
            background: #f8f9fa;
            border-bottom: 1px solid #e1e5e9;
            padding: 1rem 1.5rem;
            font-weight: 500;
            color: #222;
        }

        .wiki-card-content {
            padding: 1.5rem;
        }

        /* Filter section styling */
        .filter-section {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 2px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-title {
            color: #0645ad;
            font-weight: 500;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #eaecf0;
            padding-bottom: 0.5rem;
        }

        /* Results section */
        .results-section {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 2px;
            overflow: hidden;
        }

        .results-header {
            background: #f8f9fa;
            border-bottom: 1px solid #e1e5e9;
            padding: 1rem 1.5rem;
        }

        .results-title {
            color: #222;
            font-weight: 500;
            font-size: 1.25rem;
            margin: 0;
        }

        .results-subtitle {
            color: #72777d;
            font-size: 0.875rem;
            margin: 0.25rem 0 0 0;
        }

        /* Chart container */
        #chartContainer {
            background: white;
            border: 1px solid #e1e5e9;
            border-top: none;
            padding: 1.5rem;
            min-height: 550px;
        }

        #chartContainer .plotly-graph-div {
            width: 100% !important;
            height: 550px !important;
        }

        /* Table styling */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 500;
            color: #222;
            font-size: 0.875rem;
        }

        .data-table td {
            border: 1px solid #e1e5e9;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #222;
        }

        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tr:hover {
            background: #eaf3ff;
        }

        /* Back link styling */
        .back-link {
            color: #0645ad;
            text-decoration: none;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            margin-bottom: 1rem;
            transition: color 0.2s ease;
        }

        .back-link:hover {
            color: #0b4ba0;
            text-decoration: underline;
        }



        /* Mobile responsive */
        @media (max-width: 640px) {
            .project-selector-dropdown {
                max-height: 250px;
            }

            .project-selector-item {
                padding: 0.625rem 0.75rem;
            }

            .project-selector-item-title {
                font-size: 0.875rem;
            }

            .project-selector-item-subtitle {
                font-size: 0.75rem;
            }

            #chartContainer {
                min-height: 400px;
                padding: 0.5rem;
                margin-top: -8px;
            }

            #chartContainer .plotly-graph-div {
                height: 400px !important;
            }

            #mainContent {
                padding: 1rem;
            }
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar on the left -->
        <div id="sidebar" class="h-full sidebar-transition relative">
            <div class="sidebar-content">
                <!-- Back to Home Link -->
                <div class="mb-6">
                    <a href="/" class="back-link">
                        ← Back to All Metrics
                    </a>
                </div>

                <div class="filter-title">Filters</div>

                <!-- Two-Step Project Selector -->
                <div class="mb-6">
                    <div id="projectSelector" class="relative">
                        <div class="project-selector-input-container">
                            <input type="text" id="projectSelectorInput" class="form-input w-full px-3 py-2 pr-10"
                                placeholder="Search projects..." autocomplete="off" readonly>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <div id="projectSelectorDropdown" class="project-selector-dropdown hidden">
                            <div class="project-selector-list" id="projectSelectorList">
                                <!-- Dynamic content will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-6">
                    <button id="openDateModal" class="form-input w-full px-3 py-2 bg-white cursor-pointer">
                        Select Date Range
                    </button>
                </div>

                <!-- TODO -->
                <!-- Filters Section -->
                <div class="flex flex-col space-y-4"></div>
                <div class="flex items-center hidden">
                    <input type="checkbox" id="filterEdits" class="mr-2">
                    <label for="filterEdits" class="text-md">Edits Count</label>
                </div>
                <div class="flex items-center hidden">
                    <input type="checkbox" id="filterUsers" class="mr-2">
                    <label for="filterUsers" class="text-md">Users Count</label>
                </div>

                <!-- Submit Button -->
                <div class="mt-4">
                    <button id="submitButton" class="form-button w-full px-4 py-2">
                        Analyze Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content Section -->
        <div id="mainContent" class="flex-1">
            <div class="content-container">
                <div class="page-header">
                    <h1 class="page-title">{{ page_title or 'Wikimedia Communities Activity Logs' }}</h1>
                    <p class="page-subtitle">{{ 'Analyze edit activity patterns and detect significant changes' if
                        metric_type == 'edits' else 'Monitor editor participation and community engagement' }}</p>

                </div>

                {% if error %}
                <div class="wiki-card">
                    <div class="wiki-card-content text-center text-red-600">
                        <p>{{ error }}</p>
                    </div>
                </div>
                {% elif data %}

                <div class="results-section">
                    <div class="results-header">
                        <h2 class="results-title">{{ data|length }} {{ 'Peak' if data|length == 1 else 'Peaks' }}
                            Detected</h2>
                        <p class="results-subtitle">Activity spikes above 30% of 3-year rolling average</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Timestamp</th>
                                    <th>{{ 'Edits' if metric_type == 'edits' else 'Editors' }}</th>
                                    <th>Difference</th>
                                    <th>Rolling Mean</th>
                                    <th>Threshold</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in data %}
                                <tr>
                                    <td>{{ entry.timestamp }}</td>
                                    <td>{{ entry[metric_type] }}</td>
                                    <td>{{ entry.percentage_difference }}%</td>
                                    <td>{{ entry.rolling_mean }}</td>
                                    <td>{{ entry.threshold }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
                {% if chart %}
                <div id="chartContainer">
                    {{ chart|safe }}
                </div>
                {% elif not data %}
                <div class="wiki-card">
                    <div class="wiki-card-content text-center text-gray-500">
                        <p>No data available to display.</p>
                        <p class="text-sm mt-2">Please select a project, language, and date range to analyze community
                            activity.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Button to toggle sidebar -->
        <button id="toggleSidebar"
            class="toggle-button fixed left-4 top-4 text-gray-700 hover:text-gray-900 transition-colors">
            <span id="collapseIcon" class="block">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"
                    class="collapse-icon">
                    <path fill="currentColor" fill-rule="evenodd"
                        d="m7.29 11.29 4-4a1.004 1.004 0 0 1 1.42 1.42L10.41 11H19a1 1 0 1 1 0 2h-8.59l2.3 2.29a1 1 0 0 1 0 1.42 1 1 0 0 1-1.42 0l-4-4a1 1 0 0 1-.21-.33 1 1 0 0 1 0-.76 1 1 0 0 1 .21-.33ZM4 4a1 1 0 0 1 1 1v14a1 1 0 1 1-2 0V5a1 1 0 0 1 1-1Z"
                        clip-rule="evenodd" />
                </svg>
            </span>
            <span id="expandIcon" class="hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                    <path fill="currentColor" fill-rule="evenodd"
                        d="m15.71 11.29-4-4a1.004 1.004 0 0 0-1.42 1.42l2.3 2.29H4a1 1 0 1 0 0 2h8.59l-2.3 2.29a1 1 0 0 0 0 1.42 1 1 0 0 0 1.42 0l4-4a1 1 0 0 0 .21-.33 1 1 0 0 0 0-.76 1 1 0 0 0-.21-.33ZM19 4a1 1 0 0 0-1 1v14a1 1 0 1 0 2 0V5a1 1 0 0 0-1-1Z"
                        clip-rule="evenodd" />
                </svg>
            </span>
        </button>
    </div>

    <!-- Date Range Modal -->
    <div id="dateModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <h3 class="text-xl font-bold mb-4">Select Date Range</h3>

            <div class="mb-6">
                <div id="dateSlider" class="w-full h-2 bg-gray-200 rounded-lg relative">
                    <div id="sliderTrack" class="absolute h-full bg-green-500 rounded-lg"></div>
                    <div id="startHandle"
                        class="absolute w-5 h-5 bg-white border-2 border-green-500 rounded-full cursor-pointer -mt-1.5">
                    </div>
                    <div id="endHandle"
                        class="absolute w-5 h-5 bg-white border-2 border-green-500 rounded-full cursor-pointer -mt-1.5">
                    </div>
                </div>
            </div>

            <!-- Quick Pick Buttons -->
            <div class="mb-6 flex flex-wrap gap-2">
                <button class="quick-pick px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 text-sm" data-months="3">
                    Last 3 Months
                </button>
                <button class="quick-pick px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 text-sm" data-months="6">
                    Last 6 Months
                </button>
                <button class="quick-pick px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 text-sm" data-months="12">
                    Last 1 Year
                </button>
                <button class="quick-pick px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 text-sm" data-months="60">
                    Last 5 Years
                </button>
                <button class="quick-pick px-3 py-1 bg-gray-200 rounded-md hover:bg-gray-300 text-sm" data-months="all">
                    All Time
                </button>
            </div>

            <div class="flex justify-end space-x-2">
                <button id="closeDateModal" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="applyDateRange"
                    class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Apply</button>
            </div>
        </div>
    </div>

    <script>
        const rawLanguages = {{ languages | tojson | safe }};

        // Transform data structure for the new dropdown
        const projectData = {};

        // Map site codes to display names
        const siteCodeToName = {
            'wiki': 'Wikipedia',
            'wikibooks': 'Wikibooks',
            'wikinews': 'Wikinews',
            'wikiquote': 'Wikiquote',
            'wikisource': 'Wikisource',
            'wikiversity': 'Wikiversity',
            'wikivoyage': 'Wikivoyage',
            'wiktionary': 'Wiktionary'
        };

        const currentMetricType = "{{ metric_type }}";

        // Extract unique project types from the data
        const projectTypes = new Set();
        Object.values(rawLanguages).forEach(communities => {
            communities.forEach(community => {
                const sitename = community.sitename;
                projectTypes.add(sitename);
            });
        });

        // Create project data structure with proper display names
        Array.from(projectTypes).forEach(projectType => {
            const displayName = siteCodeToName[projectType] || projectType.charAt(0).toUpperCase() + projectType.slice(1);
            projectData[projectType] = {
                name: displayName,
                languages: []
            };
        });



        // Populate languages for each project
        Object.entries(rawLanguages).forEach(([languageName, communities]) => {
            communities.forEach(community => {
                const projectType = community.sitename;
                if (projectData[projectType]) {
                    projectData[projectType].languages.push({
                        code: languageName,
                        name: languageName,
                        url: community.url
                    });
                }
            });
        });

        // Two-Step Project Selector Class
        class TwoStepProjectSelector {
            constructor(containerId, data, callback) {
                this.container = document.getElementById(containerId);
                this.data = data;
                this.callback = callback;
                this.currentStep = 'projects';
                this.selectedProject = null;
                this.selectedLanguage = null;
                this.highlightedIndex = -1;
                this.searchTerm = '';
                this.debounceTimer = null;

                this.input = this.container.querySelector('#projectSelectorInput');
                this.dropdown = this.container.querySelector('#projectSelectorDropdown');
                this.list = this.container.querySelector('#projectSelectorList');

                this.init();
            }

            init() {
                this.input.addEventListener('click', () => this.toggleDropdown());
                this.input.addEventListener('input', (e) => this.handleSearch(e.target.value));
                this.input.addEventListener('keydown', (e) => this.handleKeydown(e));

                document.addEventListener('click', (e) => {
                    if (!this.container.contains(e.target)) {
                        this.closeDropdown();
                    }
                });

                this.showProjects();
            }

            debounce(func, wait) {
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(func, wait);
            }

            handleSearch(term) {
                this.searchTerm = term.toLowerCase();

                this.debounce(() => {
                    if (this.currentStep === 'projects') {
                        this.showProjects();
                    } else if (this.currentStep === 'languages') {
                        this.showLanguages();
                    }
                }, 150);
            }

            handleKeydown(e) {
                const items = this.list.querySelectorAll('.project-selector-item:not(.project-selector-back)');

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.highlightedIndex = Math.min(this.highlightedIndex + 1, items.length - 1);
                        this.updateHighlight();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.highlightedIndex = Math.max(this.highlightedIndex - 1, -1);
                        this.updateHighlight();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (this.highlightedIndex >= 0 && items[this.highlightedIndex]) {
                            items[this.highlightedIndex].click();
                        }
                        break;
                    case 'Escape':
                        this.closeDropdown();
                        break;
                }
            }

            updateHighlight() {
                const items = this.list.querySelectorAll('.project-selector-item:not(.project-selector-back)');
                items.forEach((item, index) => {
                    item.classList.toggle('highlighted', index === this.highlightedIndex);
                });
            }

            toggleDropdown() {
                if (this.dropdown.classList.contains('hidden')) {
                    this.openDropdown();
                } else {
                    this.closeDropdown();
                }
            }

            openDropdown() {
                this.input.removeAttribute('readonly');
                this.dropdown.classList.remove('hidden');
                this.input.focus();
            }

            closeDropdown() {
                this.dropdown.classList.add('hidden');
                this.input.setAttribute('readonly', '');
                this.highlightedIndex = -1;
            }

            showProjects() {
                this.currentStep = 'projects';
                const filteredProjects = Object.entries(this.data).filter(([key, project]) =>
                    project.name.toLowerCase().includes(this.searchTerm)
                );

                if (filteredProjects.length === 0) {
                    this.list.innerHTML = '<div class="project-selector-no-results">No projects found</div>';
                    return;
                }

                this.list.innerHTML = filteredProjects.map(([key, project]) => `
                    <div class="project-selector-item" data-project="${key}">
                        <div class="project-selector-item-main">
                            <div class="project-selector-item-title">${project.name}</div>
                            <div class="project-selector-item-subtitle">${project.languages.length} languages available</div>
                        </div>
                        <div class="project-selector-arrow">→</div>
                    </div>
                `).join('');

                this.list.querySelectorAll('.project-selector-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const projectKey = item.dataset.project;
                        this.selectProject(projectKey);
                    });
                });
            }

            showLanguages() {
                this.currentStep = 'languages';
                const project = this.data[this.selectedProject];
                const filteredLanguages = project.languages.filter(lang =>
                    lang.name.toLowerCase().includes(this.searchTerm)
                );



                let html = `
                    <div class="project-selector-back">
                        <span class="project-selector-back-arrow">←</span>
                        Back to projects
                    </div>
                `;

                if (filteredLanguages.length === 0) {
                    html += '<div class="project-selector-no-results">No languages found</div>';
                } else {
                    html += filteredLanguages.map(lang => `
                        <div class="project-selector-item" data-language="${lang.code}" data-url="${lang.url}">
                            <div class="project-selector-item-main">
                                <div class="project-selector-item-title">${lang.name}</div>
                                <div class="project-selector-item-subtitle">${project.name} - ${lang.name}</div>
                            </div>
                        </div>
                    `).join('');
                }

                this.list.innerHTML = html;

                const backButton = this.list.querySelector('.project-selector-back');
                if (backButton) {
                    backButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.selectedProject = null;
                        this.searchTerm = '';
                        this.input.value = '';
                        this.input.placeholder = 'Search projects...';
                        // Ensure input is ready for typing
                        this.input.removeAttribute('readonly');
                        this.input.focus();
                        this.showProjects();
                    });
                }

                this.list.querySelectorAll('.project-selector-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const languageCode = item.dataset.language;
                        const url = item.dataset.url;
                        this.selectLanguage(languageCode, url);
                    });
                });
            }

            selectProject(projectKey) {
                this.selectedProject = projectKey;
                this.searchTerm = '';
                this.input.value = '';
                this.input.placeholder = `Search ${this.data[projectKey].name} languages...`;
                // Ensure input is ready for typing
                this.input.removeAttribute('readonly');
                this.input.focus();
                this.showLanguages();
            }

            selectLanguage(languageCode, url) {
                this.selectedLanguage = languageCode;
                const project = this.data[this.selectedProject];
                const language = project.languages.find(l => l.code === languageCode);

                this.input.value = `${project.name} – ${language.name}`;
                this.input.placeholder = 'Search projects...';
                this.closeDropdown();

                if (this.callback) {
                    this.callback({
                        project: this.selectedProject,
                        projectName: project.name,
                        language: languageCode,
                        languageName: language.name,
                        url: url
                    });
                }
            }

            reset() {
                this.selectedProject = null;
                this.selectedLanguage = null;
                this.currentStep = 'projects';
                this.searchTerm = '';
                this.input.value = '';
                this.input.placeholder = 'Search projects...';
                this.closeDropdown();
            }
        }

        // Initialize the selector
        let selectedProjectData = null;
        const projectSelector = new TwoStepProjectSelector('projectSelector', projectData, (selection) => {
            selectedProjectData = selection;

        });

        const toggleSidebarButton = document.getElementById("toggleSidebar");
        const sidebar = document.getElementById("sidebar");
        const collapseIcon = document.getElementById("collapseIcon");
        const expandIcon = document.getElementById("expandIcon");
        let isCollapsed = false;


        const filterEdits = document.getElementById("filterEdits");
        const filterUsers = document.getElementById("filterUsers");

        toggleSidebarButton.addEventListener("click", () => {
            isCollapsed = !isCollapsed;
            if (isCollapsed) {
                sidebar.classList.add("sidebar-collapsed");
                collapseIcon.classList.add("hidden");
                expandIcon.classList.remove("hidden");
            } else {
                sidebar.classList.remove("sidebar-collapsed");
                collapseIcon.classList.remove("hidden");
                expandIcon.classList.add("hidden");
            }
        });

        // Date Range Slider functionality
        const dateModal = document.getElementById('dateModal');
        const openDateModal = document.getElementById('openDateModal');
        const closeDateModal = document.getElementById('closeDateModal');
        const applyDateRange = document.getElementById('applyDateRange');

        const startHandle = document.getElementById('startHandle');
        const endHandle = document.getElementById('endHandle');
        const sliderTrack = document.getElementById('sliderTrack');
        const dateSlider = document.getElementById('dateSlider');

        // Generate dates from 2014 to current date
        const startYear = 2014;
        const endYear = new Date().getFullYear();
        const totalMonths = ((endYear - startYear) * 12) + new Date().getMonth() + 1;

        let startValue = 0;
        let endValue = totalMonths - 1;

        function updateSliderTrack() {
            const sliderWidth = dateSlider.offsetWidth;
            const startPos = (startValue / (totalMonths - 1)) * sliderWidth;
            const endPos = (endValue / (totalMonths - 1)) * sliderWidth;

            sliderTrack.style.left = `${startPos}px`;
            sliderTrack.style.width = `${endPos - startPos}px`;
            startHandle.style.left = `${startPos}px`;
            endHandle.style.left = `${endPos}px`;
        }

        function getDateFromValue(value) {
            const months = [
                "Jan", "Feb", "Mar", "Apr", "May", "Jun",
                "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
            ];
            const month = value % 12;
            const year = Math.floor(value / 12) + startYear;
            return `${months[month]} ${year}`;
        }


        function updateDateDisplay() {
            document.getElementById('openDateModal').textContent = `${getDateFromValue(startValue)} - ${getDateFromValue(endValue)}`;
        }

        // Quick pick functionality
        document.querySelectorAll('.quick-pick').forEach(button => {
            button.addEventListener('click', () => {
                const months = button.dataset.months;
                endValue = totalMonths - 1;

                if (months === 'all') {
                    startValue = 0;
                } else {
                    startValue = Math.max(0, endValue - parseInt(months) + 1);
                }

                updateSliderTrack();
                updateDateDisplay();
            });
        });

        // Drag functionality
        let isDragging = null;

        function handleDrag(e) {
            if (!isDragging) return;

            const rect = dateSlider.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            const value = Math.round(pos * (totalMonths - 1));

            if (isDragging === startHandle && value < endValue) {
                startValue = Math.max(0, value);
            } else if (isDragging === endHandle && value > startValue) {
                endValue = Math.min(totalMonths - 1, value);
            }

            updateSliderTrack();
            updateDateDisplay();
        }

        // Event Listeners
        openDateModal.addEventListener('click', () => {
            dateModal.classList.remove('hidden');
            updateSliderTrack();
            updateDateDisplay();
        });

        closeDateModal.addEventListener('click', () => {
            dateModal.classList.add('hidden');
        });

        applyDateRange.addEventListener('click', () => {
            dateModal.classList.add('hidden');
        });

        [startHandle, endHandle].forEach(handle => {
            handle.addEventListener('mousedown', (e) => {
                isDragging = handle;
                e.preventDefault();
            });
        });

        document.addEventListener('mousemove', handleDrag);
        document.addEventListener('mouseup', () => {
            isDragging = null;
        });

        // Initial setup
        updateSliderTrack();
        updateDateDisplay();

        // Search functionality
        function search() {
            if (!selectedProjectData) {
                alert('Please select a project and language first.');
                return;
            }

            const startDate = getDateFromValue(startValue);
            const endDate = getDateFromValue(endValue);

            // Navigate to the current metric type with new parameters
            const baseUrl = currentMetricType === 'edits' ? '/edits' : '/editors';
            window.location.href = `${baseUrl}?language=${selectedProjectData.languageName}&project_group=${selectedProjectData.url}&datestart=${startDate}&dateend=${endDate}`;
        }

        document.getElementById('submitButton').addEventListener('click', search);

        // Load filters from URL
        document.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);

            // Set project selector value
            const language = urlParams.get("language");
            const projectGroup = urlParams.get("project_group");

            if (language && projectGroup) {
                // Find the matching project and language
                for (const [projectKey, project] of Object.entries(projectData)) {
                    const matchingLang = project.languages.find(lang =>
                        lang.name === language && lang.url === projectGroup
                    );
                    if (matchingLang) {
                        selectedProjectData = {
                            project: projectKey,
                            projectName: project.name,
                            language: matchingLang.code,
                            languageName: matchingLang.name,
                            url: matchingLang.url
                        };

                        // Update the input display
                        document.getElementById('projectSelectorInput').value =
                            `${project.name} – ${matchingLang.name}`;
                        break;
                    }
                }
            }

            // Set date range
            const datestart = urlParams.get("datestart");
            const dateend = urlParams.get("dateend");
            const dateModal = document.getElementById("openDateModal");
            if (datestart && dateend) {
                dateModal.textContent = `${datestart} - ${dateend}`;
            }

            // Set filter checkboxes
            const filterEditsValue = urlParams.get("filter_edits");
            if (filterEditsValue === "true") {
                filterEdits.checked = true;
            }

            const filterUsersValue = urlParams.get("filter_users");
            if (filterUsersValue === "true") {
                filterUsers.checked = true;
            }
        });

        // Peak labeling functionality
        document.addEventListener("DOMContentLoaded", () => {
            const chartContainer = document.getElementById('chartContainer');
            if (chartContainer) {
                const plotDiv = chartContainer.querySelector('.plotly-graph-div');
                if (plotDiv) {
                    let hoverInput = null;
                    let isInputActive = false;
                    let currentProject = null;
                    let currentTimestamp = null;

                    plotDiv.on('plotly_hover', function (data) {
                        const point = data.points[0];
                        if (point.curveNumber === 1) { // Peaks are the second trace
                            const customData = point.customdata;
                            currentProject = customData.project;
                            currentTimestamp = customData.timestamp;

                            if (!hoverInput) {
                                hoverInput = document.createElement('div');
                                hoverInput.style.position = 'absolute';
                                hoverInput.style.backgroundColor = 'white';
                                hoverInput.style.border = '1px solid #ccc';
                                hoverInput.style.padding = '3px';
                                hoverInput.style.zIndex = '1000';
                                hoverInput.style.display = 'flex';
                                hoverInput.style.alignItems = 'center';
                                hoverInput.style.borderRadius = '4px';
                                hoverInput.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';

                                const input = document.createElement('input');
                                input.type = 'text';
                                input.placeholder = 'Enter label...';
                                input.style.marginRight = '5px';
                                input.style.border = '1px solid #ddd';
                                input.style.padding = '2px 4px';

                                const saveButton = document.createElement('button');
                                saveButton.textContent = 'Save';
                                saveButton.style.marginRight = '5px';
                                saveButton.style.padding = '2px 8px';
                                saveButton.style.backgroundColor = '#4CAF50';
                                saveButton.style.color = 'white';
                                saveButton.style.border = 'none';
                                saveButton.style.borderRadius = '2px';
                                saveButton.style.cursor = 'pointer';

                                const saveLabel = () => {
                                    const label = input.value;
                                    fetch('/api/update_peak_label', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            project: currentProject,
                                            timestamp: currentTimestamp,
                                            label: label,
                                            metric_type: currentMetricType
                                        }),
                                    }).then(response => response.json())
                                        .then(data => {
                                            if (data.success) {
                                                alert('Label updated successfully!');
                                                hoverInput.style.display = 'none';
                                                isInputActive = false;
                                                // Optionally reload to show updated chart
                                                window.location.reload();
                                            } else {
                                                alert('Error updating label: ' + data.error);
                                            }
                                        });
                                };

                                input.addEventListener('keypress', (e) => {
                                    if (e.key === 'Enter') {
                                        saveLabel();
                                    }
                                });
                                saveButton.addEventListener('click', saveLabel);

                                const closeButton = document.createElement('button');
                                closeButton.textContent = '×';
                                closeButton.style.marginLeft = '5px';
                                closeButton.style.padding = '2px 6px';
                                closeButton.style.backgroundColor = '#f44336';
                                closeButton.style.color = 'white';
                                closeButton.style.border = 'none';
                                closeButton.style.borderRadius = '2px';
                                closeButton.style.cursor = 'pointer';
                                closeButton.addEventListener('click', () => {
                                    hoverInput.style.display = 'none';
                                    isInputActive = false;
                                });

                                hoverInput.appendChild(input);
                                hoverInput.appendChild(saveButton);
                                hoverInput.appendChild(closeButton);
                                document.body.appendChild(hoverInput);

                                // Prevent input box from disappearing when interacting with it
                                hoverInput.addEventListener('mouseenter', () => {
                                    isInputActive = true;
                                });
                                hoverInput.addEventListener('mouseleave', () => {
                                    isInputActive = false;
                                });
                            }

                            // Get chart container position for relative positioning
                            const chartRect = plotDiv.getBoundingClientRect();
                            const relativeX = data.event.clientX - chartRect.left;
                            const relativeY = data.event.clientY - chartRect.top;

                            // Fetch existing label
                            fetch(`/api/get_peak_label?project=${currentProject}&timestamp=${currentTimestamp}&metric_type=${currentMetricType}`)
                                .then(response => response.json())
                                .then(data => {
                                    const input = hoverInput.querySelector('input');
                                    input.value = data.label || '';

                                    // Position relative to chart container with scroll offset
                                    const updatedChartRect = plotDiv.getBoundingClientRect();
                                    hoverInput.style.left = `${updatedChartRect.left + relativeX + window.pageXOffset}px`;
                                    hoverInput.style.top = `${updatedChartRect.top + relativeY + window.pageYOffset}px`;
                                    hoverInput.style.display = 'flex';

                                    // Focus the input and move cursor to end
                                    setTimeout(() => {
                                        input.focus();
                                        input.setSelectionRange(input.value.length, input.value.length);
                                    }, 100);
                                });

                            // Initial positioning relative to chart with scroll offset
                            hoverInput.style.left = `${chartRect.left + relativeX + window.pageXOffset}px`;
                            hoverInput.style.top = `${chartRect.top + relativeY + window.pageYOffset}px`;
                            hoverInput.style.display = 'flex';
                            isInputActive = true;
                        }
                    });

                    plotDiv.on('plotly_unhover', () => {
                        setTimeout(() => {
                            if (!isInputActive && hoverInput) {
                                hoverInput.style.display = 'none';
                            }
                        }, 200);
                    });

                    document.addEventListener('click', (event) => {
                        if (hoverInput && !hoverInput.contains(event.target)) {
                            hoverInput.style.display = 'none';
                            isInputActive = false;
                        }
                    });
                }
            }
        });

    </script>
</body>

</html>