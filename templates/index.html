<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikimedia Communities Activity Logs</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .sidebar-transition {
            transition: all 1s ease;
        }

        .sidebar-collapsed {
            width: 0;
            padding: 0;
            margin: 0;
        }

        .sidebar-content {
            width: 20rem;
            /* w-80 equivalent */
            transition: all 0.3s ease;
        }

        .sidebar-collapsed .sidebar-content {
            transform: translateX(-100%);
            opacity: 0;
        }

        .toggle-button {
            transition: transform 0.3s ease, left 0.3s ease;
        }

        .toggle-button.collapsed {
            left: 0.5rem;
        }

        /* Custom select styling */
        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='currentColor'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25rem;
            padding-right: 2.5rem !important;
        }

        input[type="checkbox"]:checked {
            accent-color: green;
        }

        #dateSlider {
            user-select: none;
        }

        #sliderTrack {
            transition: all 0.1s ease;
        }

        #startHandle,
        #endHandle {
            transform: translateX(-50%);
            transition: all 0.1s ease;
        }

        /* Project Selector Styles */
        .project-selector-input-container {
            position: relative;
        }

        .project-selector-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 50;
            max-height: 300px;
            overflow-y: auto;
            animation: dropdownFadeIn 0.15s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .project-selector-list {
            padding: 0.5rem 0;
        }

        .project-selector-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.15s ease;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .project-selector-item:hover,
        .project-selector-item.highlighted {
            background-color: #f9fafb;
            border-left-color: #10b981;
        }

        .project-selector-item.selected {
            background-color: #ffe1ee;
            border-left-color: #ec4899;
        }

        .project-selector-item-main {
            flex: 1;
            min-width: 0;
        }

        .project-selector-item-title {
            font-weight: 500;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-selector-item-subtitle {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.125rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-selector-arrow {
            margin-left: 0.5rem;
            color: #9ca3af;
            transition: transform 0.15s ease;
        }

        .project-selector-item:hover .project-selector-arrow {
            transform: translateX(2px);
        }

        .project-selector-separator {
            height: 1px;
            background-color: #e5e7eb;
            margin: 0.5rem 0;
        }

        .project-selector-back {
            padding: 0.75rem 1rem;
            cursor: pointer;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            font-weight: 500;
            color: #374151;
            transition: background-color 0.15s ease;
        }

        .project-selector-back:hover {
            background-color: #f3f4f6;
        }

        .project-selector-back-arrow {
            margin-right: 0.5rem;
            transition: transform 0.15s ease;
        }

        .project-selector-back:hover .project-selector-back-arrow {
            transform: translateX(-2px);
        }

        .project-selector-loading {
            padding: 2rem 1rem;
            text-align: center;
            color: #6b7280;
        }

        .project-selector-no-results {
            padding: 2rem 1rem;
            text-align: center;
            color: #6b7280;
            font-style: italic;
        }

        /* Mobile responsive */
        @media (max-width: 640px) {
            .project-selector-dropdown {
                max-height: 250px;
            }

            .project-selector-item {
                padding: 0.625rem 0.75rem;
            }

            .project-selector-item-title {
                font-size: 0.875rem;
            }

            .project-selector-item-subtitle {
                font-size: 0.75rem;
            }
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar on the left -->
        <div id="sidebar" class="bg-white h-full shadow-lg sidebar-transition relative">
            <div class="sidebar-content p-4 pt-16 space-y-6">
                <h2 class="text-2xl font-bold">Filters</h2>

                <!-- Two-Step Project Selector -->
                <div id="projectSelector" class="relative">
                    <div class="project-selector-input-container">
                        <input type="text" id="projectSelectorInput"
                            class="w-full rounded-md px-4 py-2 pr-10 border focus:outline-none focus:ring-2 focus:ring-green-500"
                            placeholder="Search projects..." autocomplete="off">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div id="projectSelectorDropdown" class="project-selector-dropdown hidden">
                        <div class="project-selector-list" id="projectSelectorList"></div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                    <div id="dateRangeDisplay"
                        class="text-sm text-gray-800 bg-gray-50 border rounded px-3 py-2 cursor-pointer hover:bg-gray-100 transition-colors">
                        —</div>
                </div>

                <div class="space-y-2 hidden">
                    <label class="inline-flex items-center space-x-2 text-sm">
                        <input id="filterEdits" type="checkbox" class="h-4 w-4"> <span>Filter Edits</span>
                    </label>
                    <label class="inline-flex items-center space-x-2 text-sm">
                        <input id="filterUsers" type="checkbox" class="h-4 w-4"> <span>Filter Users</span>
                    </label>
                </div>

                <div>
                    <button id="submitButton"
                        class="w-full bg-green-600 text-white rounded px-4 py-2 hover:bg-green-700 transition-colors">Search</button>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="relative flex-1 p-6">
            <!-- Login/Logout Button -->
            {% if user %}
            <a href="{{ base_url }}/logout"
                class="absolute top-6 right-6 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors">
                Logout
            </a>
            {% else %}
            <a href="{{ base_url }}/login"
                class="absolute top-6 right-6 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors">
                Login
            </a>
            {% endif %}

            <!-- Centered Heading -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800">Wikimedia Communities Activity Logs</h1>
            </div>

            <!-- No Data Message - placed below heading -->
            {% if not data and not chart %}
            <div class="text-center text-gray-500 mb-8">
                <p class="text-lg">No data available to display.</p>
                <p class="text-sm mt-2">Please select a project and date range, then click Submit to view activity data.
                </p>
            </div>
            {% endif %}


            <!-- Results Section -->
            {% if data %}
            <div class="mb-6">
                <h2 class="text-2xl font-semibold mb-4">Detected Peaks</h2>
                <div class="overflow-x-auto mb-8 border rounded bg-white shadow">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left font-medium text-gray-600">Date</th>
                                <th class="px-4 py-2 text-left font-medium text-gray-600">Edits</th>
                                <th class="px-4 py-2 text-left font-medium text-gray-600">Rolling Mean</th>
                                <th class="px-4 py-2 text-left font-medium text-gray-600">Threshold</th>
                                <th class="px-4 py-2 text-left font-medium text-gray-600">% Diff</th>
                                <th class="px-4 py-2 text-left font-medium text-gray-600">Label</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for row in data %}
                            <tr>
                                <td class="px-4 py-2 whitespace-nowrap">{{ row.timestamp }}</td>
                                <td class="px-4 py-2">{{ row.edits }}</td>
                                <td class="px-4 py-2">{{ row.rolling_mean }}</td>
                                <td class="px-4 py-2">{{ row.threshold }}</td>
                                <td class="px-4 py-2">{{ row.percentage_difference }}</td>
                                <td class="px-4 py-2">{{ row.label or '' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Chart Section -->
            {% if chart %}
            <div class="mt-4" id="chartContainer">{{ chart|safe }}</div>
            {% endif %}
        </div>

        <!-- Button to toggle sidebar -->
        <button id="toggleSidebar"
            class="toggle-button absolute left-4 top-6 text-gray-700 hover:text-gray-900 transition-colors z-10">
            <span id="collapseIcon" class="block">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"
                    class="collapse-icon">
                    <path fill="currentColor" fill-rule="evenodd"
                        d="m7.29 11.29 4-4a1.004 1.004 0 0 1 1.42 1.42L10.41 11H19a1 1 0 1 1 0 2h-8.59l2.3 2.29a1 1 0 0 1 0 1.42 1 1 0 0 1-1.42 0l-4-4a1 1 0 0 1-.21-.33 1 1 0 0 1 0-.76 1 1 0 0 1 .21-.33ZM4 4a1 1 0 0 1 1 1v14a1 1 0 1 1-2 0V5a1 1 0 0 1 1-1Z"
                        clip-rule="evenodd" />
                </svg>
            </span>
            <span id="expandIcon" class="hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                    <path fill="currentColor" fill-rule="evenodd"
                        d="m15.71 11.29-4-4a1.004 1.004 0 0 0-1.42 1.42l2.3 2.29H4a1 1 0 1 0 0 2h8.59l-2.3 2.29a1 1 0 0 0 0 1.42 1 1 0 0 0 1.42 0l4-4a1 1 0 0 0 .21-.33 1 1 0 0 0 0-.76 1 1 0 0 0-.21-.33ZM19 4a1 1 0 0 0-1 1v14a1 1 0 1 0 2 0V5a1 1 0 0 0-1-1Z"
                        clip-rule="evenodd" />
                </svg>
            </span>
        </button>
    </div>

    <!-- Date Range Modal -->
    <div id="dateModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-[30rem] relative">
            <h3 class="text-xl font-bold mb-4">Select Date Range</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="startMonth" class="block text-xs font-medium text-gray-600 mb-1">Start</label>
                    <input type="month" id="startMonth" class="w-full border rounded px-2 py-2 text-sm" />
                </div>
                <div>
                    <label for="endMonth" class="block text-xs font-medium text-gray-600 mb-1">End</label>
                    <input type="month" id="endMonth" class="w-full border rounded px-2 py-2 text-sm" />
                </div>
            </div>
            <div class="mb-4 flex flex-wrap gap-2">
                <button class="quick-pick px-3 py-1.5 text-xs bg-gray-100 rounded hover:bg-gray-200"
                    data-range="3m">Last 3 mo</button>
                <button class="quick-pick px-3 py-1.5 text-xs bg-gray-100 rounded hover:bg-gray-200"
                    data-range="6m">Last 6 mo</button>
                <button class="quick-pick px-3 py-1.5 text-xs bg-gray-100 rounded hover:bg-gray-200"
                    data-range="12m">Last 12 mo</button>
                <button class="quick-pick px-3 py-1.5 text-xs bg-gray-100 rounded hover:bg-gray-200"
                    data-range="all">All</button>
                <button class="quick-pick px-3 py-1.5 text-xs bg-gray-100 rounded hover:bg-gray-200"
                    data-range="ytd">YTD</button>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="closeDateModal" type="button" class="px-4 py-2 text-sm rounded border">Cancel</button>
                <button id="applyDateRange" type="button"
                    class="px-4 py-2 text-sm rounded bg-green-600 text-white hover:bg-green-700">Apply</button>
            </div>
        </div>
    </div>
    <script id="languages-data" type="application/json">{{ languages | tojson | safe }}</script>
    <script>
        // Parse languages data injected as JSON
        const rawLanguages = JSON.parse(document.getElementById('languages-data').textContent);

        // Elements
        const projectSelectorInput = document.getElementById('projectSelectorInput');
        const projectSelectorDropdown = document.getElementById('projectSelectorDropdown');
        const projectSelectorList = document.getElementById('projectSelectorList');
        const dateRangeDisplay = document.getElementById('dateRangeDisplay');
        const toggleSidebarButton = document.getElementById('toggleSidebar');
        const sidebar = document.getElementById('sidebar');
        const collapseIcon = document.getElementById('collapseIcon');
        const expandIcon = document.getElementById('expandIcon');
        const filterEdits = document.getElementById('filterEdits');
        const filterUsers = document.getElementById('filterUsers');
        const dateModal = document.getElementById('dateModal');
        const closeDateModalBtn = document.getElementById('closeDateModal');
        const applyDateRangeBtn = document.getElementById('applyDateRange');
        const startMonthInput = document.getElementById('startMonth');
        const endMonthInput = document.getElementById('endMonth');

        // Build projectData structure grouped by sitename with language list
        const projectData = {}; // { sitename: { name: readableName, languages: [{languageName, domain, url}] } }
        const projectNameMap = { wiki: 'Wikipedia', wiktionary: 'Wiktionary', wikibooks: 'Wikibooks', wikinews: 'Wikinews', wikiquote: 'Wikiquote', wikisource: 'Wikisource', wikiversity: 'Wikiversity', wikivoyage: 'Wikivoyage' };
        Object.entries(rawLanguages).forEach(([languageName, communities]) => {
            communities.forEach(c => {
                const key = c.sitename;
                if (!projectData[key]) projectData[key] = { name: projectNameMap[key] || key, languages: [] };
                try { const u = new URL(c.url); projectData[key].languages.push({ languageName, domain: u.hostname, url: c.url }); } catch { projectData[key].languages.push({ languageName, domain: c.url, url: c.url }); }
            });
        });

        let selectorState = { step: 'projects', selectedProject: null, selectedLanguage: null };

        function renderProjects(filter = '') {
            selectorState.step = 'projects';
            const entries = Object.entries(projectData).filter(([k, v]) => v.name.toLowerCase().includes(filter));
            projectSelectorList.innerHTML = entries.map(([key, proj]) => `<div class="project-selector-item" data-project="${key}"><div class="project-selector-item-main"><div class="project-selector-item-title">${proj.name}</div><div class="project-selector-item-subtitle">${proj.languages.length} languages</div></div><div class="project-selector-arrow">→</div></div>`).join('') || '<div class="project-selector-no-results">No projects</div>';
        }

        function renderLanguages(filter = '') {
            selectorState.step = 'languages';
            const proj = projectData[selectorState.selectedProject];
            let html = '<div class="project-selector-back"><span class="project-selector-back-arrow">←</span>Back</div>';
            const langs = proj.languages.filter(l => l.languageName.toLowerCase().includes(filter));
            html += langs.map(l => `<div class="project-selector-item" data-lang="${encodeURIComponent(l.languageName)}" data-domain="${l.domain}" data-url="${l.url}"><div class="project-selector-item-main"><div class="project-selector-item-title">${l.languageName}</div><div class="project-selector-item-subtitle">${proj.name}</div></div></div>`).join('') || '<div class="project-selector-no-results">No languages</div>';
            projectSelectorList.innerHTML = html;
        }

        function openDropdown() { projectSelectorDropdown.classList.remove('hidden'); }
        function closeDropdown() { projectSelectorDropdown.classList.add('hidden'); }

        projectSelectorInput.addEventListener('click', (e) => {
            e.stopPropagation();
            if (projectSelectorDropdown.classList.contains('hidden')) {
                openDropdown();
                if (selectorState.step === 'projects') renderProjects(projectSelectorInput.value.toLowerCase());
                else renderLanguages(projectSelectorInput.value.toLowerCase());
            }
        });
        projectSelectorInput.addEventListener('focus', () => {
            if (projectSelectorDropdown.classList.contains('hidden')) {
                openDropdown();
                if (selectorState.step === 'projects') renderProjects(projectSelectorInput.value.toLowerCase());
                else renderLanguages(projectSelectorInput.value.toLowerCase());
            }
        });
        projectSelectorInput.addEventListener('input', e => {
            const val = e.target.value.toLowerCase();
            if (projectSelectorDropdown.classList.contains('hidden')) {
                openDropdown();
            }
            if (selectorState.step === 'projects') renderProjects(val);
            else renderLanguages(val);
        });
        document.addEventListener('click', e => {
            if (!document.getElementById('projectSelector').contains(e.target)) closeDropdown();
        });
        projectSelectorList.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();
            const item = e.target.closest('.project-selector-item');
            if (!item) {
                if (e.target.closest('.project-selector-back')) {
                    selectorState.selectedProject = null;
                    projectSelectorInput.value = '';
                    projectSelectorInput.placeholder = 'Search projects...';
                    renderProjects();
                }
                return;
            }
            if (selectorState.step === 'projects') {
                selectorState.selectedProject = item.dataset.project;
                projectSelectorInput.value = '';
                projectSelectorInput.placeholder = 'Search languages...';
                // Keep dropdown open and render languages
                renderLanguages();
                // Keep focus on input
                projectSelectorInput.focus();
            }
            else if (selectorState.step === 'languages') {
                selectorState.selectedLanguage = decodeURIComponent(item.dataset.lang);
                selectorState.domain = item.dataset.domain;
                projectSelectorInput.value = `${projectData[selectorState.selectedProject].name} – ${selectorState.selectedLanguage}`;
                // Only close dropdown when final selection is made
                closeDropdown();
            }
        });

        // Sidebar toggle
        toggleSidebarButton.addEventListener('click', () => {
            const collapsed = sidebar.classList.toggle('sidebar-collapsed');
            collapseIcon.classList.toggle('hidden', collapsed);
            expandIcon.classList.toggle('hidden', !collapsed);
        });

        // Date handling
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        function formatDisplayRange() {
            if (!startMonthInput.value || !endMonthInput.value) { dateRangeDisplay.textContent = '—'; return; }
            const [sY, sM] = startMonthInput.value.split('-').map(Number);
            const [eY, eM] = endMonthInput.value.split('-').map(Number);
            dateRangeDisplay.textContent = `${monthNames[sM - 1]} ${sY} → ${monthNames[eM - 1]} ${eY}`;
        }

        dateRangeDisplay.addEventListener('click', () => { dateModal.classList.remove('hidden'); });
        closeDateModalBtn.addEventListener('click', () => { dateModal.classList.add('hidden'); });
        applyDateRangeBtn.addEventListener('click', () => { formatDisplayRange(); dateModal.classList.add('hidden'); });

        document.querySelectorAll('.quick-pick').forEach(btn => {
            btn.addEventListener('click', () => {
                const now = new Date();
                let start;
                const range = btn.dataset.range;
                if (range === 'all') { start = new Date(2014, 0, 1); }
                else if (range === 'ytd') { start = new Date(now.getFullYear(), 0, 1); }
                else if (/m$/.test(range)) { const months = parseInt(range.slice(0, -1), 10); start = new Date(now.getFullYear(), now.getMonth() - (months - 1), 1); }
                else { start = new Date(now.getFullYear(), now.getMonth(), 1); }
                const end = new Date(now.getFullYear(), now.getMonth(), 1);
                startMonthInput.value = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, '0')}`;
                endMonthInput.value = `${end.getFullYear()}-${String(end.getMonth() + 1).padStart(2, '0')}`;
                formatDisplayRange();
            });
        });

        // Submit/search
        document.getElementById('submitButton').addEventListener('click', () => {
            if (!selectorState.selectedProject || !selectorState.selectedLanguage || !selectorState.domain) { alert('Select a project and language first.'); return; }
            if (!startMonthInput.value || !endMonthInput.value) { alert('Select date range'); return; }
            const [startY, startM] = startMonthInput.value.split('-').map(Number);
            const [endY, endM] = endMonthInput.value.split('-').map(Number);
            const datestart = `${monthNames[startM - 1]} ${startY}`;
            const dateend = `${monthNames[endM - 1]} ${endY}`;
            const language = selectorState.selectedLanguage; // using language name
            const project_group = encodeURIComponent(`${language}:/${selectorState.domain}`);
            const params = new URLSearchParams({ language, project_group, datestart, dateend, filter_edits: filterEdits.checked, filter_users: filterUsers.checked });
            window.location.search = params.toString();
        });

        (function init() {
            renderProjects();
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth() - 11, 1);
            startMonthInput.value = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, '0')}`;
            endMonthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            formatDisplayRange();
            const qs = new URLSearchParams(window.location.search);
            if (qs.get('language') && qs.get('project_group')) {
                const language = qs.get('language');
                const pg = decodeURIComponent(qs.get('project_group'));
                const domain = pg.split(':/')[1];
                // Find the project containing this domain
                Object.entries(projectData).forEach(([projKey, proj]) => {
                    const langEntry = proj.languages.find(l => l.languageName === language && l.domain === domain);
                    if (langEntry) {
                        selectorState.selectedProject = projKey;
                        selectorState.selectedLanguage = language;
                        selectorState.domain = domain;
                        projectSelectorInput.value = `${proj.name} – ${language}`;
                    }
                });
            }
            if (qs.get('datestart') && qs.get('dateend')) { const ds = qs.get('datestart').split(' '); const de = qs.get('dateend').split(' '); const sm = monthNames.indexOf(ds[0]) + 1; const em = monthNames.indexOf(de[0]) + 1; if (sm > 0 && em > 0) { startMonthInput.value = `${ds[1]}-${String(sm).padStart(2, '0')}`; endMonthInput.value = `${de[1]}-${String(em).padStart(2, '0')}`; formatDisplayRange(); } }
            filterEdits.checked = qs.get('filter_edits') === 'true';
            filterUsers.checked = qs.get('filter_users') === 'true';
        })();
    </script>
</body>

</html>