<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikimedia Communities Activity Logs</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        /* Wikimedia Codex Design System Styles */

        /* Typography - Following Codex font stack */
        * {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Lato, Helvetica, Arial, sans-serif;
        }

        /* Codex Color Palette */
        :root {
            /* Base colors */
            --color-base: #ffffff;
            --color-emphasized: #000000;
            --color-subtle: #72777d;
            --color-muted: #a2a9b1;

            /* Background colors */
            --background-color-base: #ffffff;
            --background-color-neutral: #f8f9fa;
            --background-color-neutral-subtle: #eaecf0;

            /* Border colors */
            --border-color-base: #a2a9b1;
            --border-color-subtle: #c8ccd1;
            --border-color-muted: #eaecf0;

            /* App theme colors - Green based */
            --color-progressive: #099979;
            --color-progressive-hover: #14876b;
            --color-progressive-active: #177860;

            /* Status colors */
            --color-error: #d73333;
            --color-warning: #ffcc33;
            --color-success: #099979;

            /* Data visualization colors - Green theme */
            --dataviz-green-600: #099979;
            --dataviz-green-500: #14876b;
            --dataviz-green-400: #2cb491;
            --dataviz-green-300: #80cdb3;
            --dataviz-green-200: #aedfcd;

            /* Chart background */
            --chart-background: #ffffff;
            --chart-grid: #eaecf0;
            --chart-axis: #a2a9b1;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --color-base: #ffffff;
                --color-emphasized: #ffffff;
                --color-subtle: #a2a9b1;
                --color-muted: #72777d;

                --background-color-base: #101418;
                --background-color-neutral: #27292d;
                --background-color-neutral-subtle: #404244;

                --border-color-base: #72777d;
                --border-color-subtle: #54595d;
                --border-color-muted: #404244;

                --chart-background: #101418;
                --chart-grid: #404244;
                --chart-axis: #72777d;
            }
        }

        .sidebar-transition {
            transition: all 1s ease;
        }

        .sidebar-collapsed {
            width: 0;
            padding: 0;
            margin: 0;
        }

        .sidebar-content {
            width: 20rem;
            /* w-80 equivalent */
            transition: all 0.3s ease;
        }

        .sidebar-collapsed .sidebar-content {
            transform: translateX(-100%);
            opacity: 0;
        }

        .toggle-button {
            transition: transform 0.3s ease, left 0.3s ease;
        }

        .toggle-button.collapsed {
            left: 0.5rem;
        }

        /* Enhanced form controls following Codex patterns */
        select,
        input[type="text"],
        input[type="month"] {
            appearance: none;
            background-color: var(--background-color-base);
            border: 1px solid var(--border-color-base);
            border-radius: 2px;
            color: var(--color-emphasized);
            font-size: 14px;
            line-height: 1.6;
            padding: 8px 12px;
            transition: border-color 0.1s ease, box-shadow 0.1s ease;
        }

        select:focus,
        input[type="text"]:focus,
        input[type="month"]:focus {
            border-color: var(--color-progressive);
            box-shadow: inset 0 0 0 1px var(--color-progressive);
            outline: none;
        }

        select:hover,
        input[type="text"]:hover,
        input[type="month"]:hover {
            border-color: var(--border-color-subtle);
        }

        /* Custom select styling */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23a2a9b1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25rem;
            padding-right: 2.5rem !important;
        }

        /* Codex-style checkboxes */
        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            border: 1px solid var(--border-color-base);
            border-radius: 2px;
            background-color: var(--background-color-base);
            cursor: pointer;
        }

        input[type="checkbox"]:checked {
            background-color: var(--color-progressive);
            border-color: var(--color-progressive);
        }

        input[type="checkbox"]:hover {
            border-color: var(--color-progressive);
        }

        #dateSlider {
            user-select: none;
        }

        #sliderTrack {
            transition: all 0.1s ease;
        }

        #startHandle,
        #endHandle {
            transform: translateX(-50%);
            transition: all 0.1s ease;
        }

        /* Project Selector Styles - Updated for Codex */
        .project-selector-input-container {
            position: relative;
        }

        .project-selector-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--background-color-base);
            border: 1px solid var(--border-color-subtle);
            border-radius: 2px;
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1);
            z-index: 50;
            max-height: 300px;
            overflow-y: auto;
            animation: dropdownFadeIn 0.15s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .project-selector-list {
            padding: 4px 0;
        }

        .project-selector-item {
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.1s ease;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--color-emphasized);
        }

        .project-selector-item:hover,
        .project-selector-item.highlighted {
            background-color: var(--background-color-neutral);
            border-left-color: var(--color-progressive);
        }

        .project-selector-item.selected {
            background-color: var(--background-color-neutral-subtle);
            border-left-color: var(--color-progressive);
        }

        .project-selector-item-main {
            flex: 1;
            min-width: 0;
        }

        .project-selector-item-title {
            font-weight: 500;
            font-size: 14px;
            color: var(--color-emphasized);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-selector-item-subtitle {
            font-size: 12px;
            color: var(--color-subtle);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-selector-arrow {
            margin-left: 8px;
            color: var(--color-muted);
            transition: transform 0.15s ease;
        }

        .project-selector-item:hover .project-selector-arrow {
            transform: translateX(2px);
        }

        .project-selector-separator {
            height: 1px;
            background-color: var(--border-color-muted);
            margin: 4px 0;
        }

        .project-selector-back {
            padding: 8px 12px;
            cursor: pointer;
            background-color: var(--background-color-neutral);
            border-bottom: 1px solid var(--border-color-muted);
            display: flex;
            align-items: center;
            font-weight: 500;
            font-size: 14px;
            color: var(--color-emphasized);
            transition: background-color 0.1s ease;
        }

        .project-selector-back:hover {
            background-color: var(--background-color-neutral-subtle);
        }

        .project-selector-back-arrow {
            margin-right: 8px;
            transition: transform 0.15s ease;
        }

        .project-selector-back:hover .project-selector-back-arrow {
            transform: translateX(-2px);
        }

        .project-selector-loading,
        .project-selector-no-results {
            padding: 24px 12px;
            text-align: center;
            color: var(--color-subtle);
            font-size: 14px;
        }

        .project-selector-no-results {
            font-style: italic;
        }

        /* Codex-style buttons */
        .btn-primary {
            background-color: var(--color-progressive);
            border: 1px solid var(--color-progressive);
            color: var(--color-base);
            font-size: 14px;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 2px;
            cursor: pointer;
            transition: background-color 0.1s ease, border-color 0.1s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary:hover {
            background-color: var(--color-progressive-hover);
            border-color: var(--color-progressive-hover);
        }

        .btn-primary:active {
            background-color: var(--color-progressive-active);
            border-color: var(--color-progressive-active);
        }

        .btn-secondary {
            background-color: var(--background-color-base);
            border: 1px solid var(--border-color-base);
            color: var(--color-emphasized);
            font-size: 14px;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 2px;
            cursor: pointer;
            transition: background-color 0.1s ease, border-color 0.1s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-secondary:hover {
            background-color: var(--background-color-neutral);
            border-color: var(--border-color-subtle);
        }

        /* Typography hierarchy following Codex guidelines */
        .text-heading-1 {
            font-size: 32px;
            font-weight: 600;
            line-height: 1.3;
            color: var(--color-emphasized);
        }

        .text-heading-2 {
            font-size: 24px;
            font-weight: 600;
            line-height: 1.3;
            color: var(--color-emphasized);
        }

        .text-heading-3 {
            font-size: 20px;
            font-weight: 600;
            line-height: 1.3;
            color: var(--color-emphasized);
        }

        .text-body {
            font-size: 14px;
            line-height: 1.6;
            color: var(--color-emphasized);
        }

        .text-body-small {
            font-size: 12px;
            line-height: 1.6;
            color: var(--color-subtle);
        }

        .text-label {
            font-size: 12px;
            font-weight: 500;
            line-height: 1.6;
            color: var(--color-emphasized);
        }

        /* Mobile responsive */
        @media (max-width: 640px) {
            .project-selector-dropdown {
                max-height: 250px;
            }

            .project-selector-item {
                padding: 10px 12px;
            }

            .project-selector-item-title {
                font-size: 12px;
            }

            .project-selector-item-subtitle {
                font-size: 11px;
            }

            .text-heading-1 {
                font-size: 28px;
            }

            .text-heading-2 {
                font-size: 20px;
            }
        }
    </style>
</head>

<body
    style="background-color: var(--background-color-neutral); margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Lato, Helvetica, Arial, sans-serif;">
    <div class="flex h-screen">
        <!-- Sidebar on the left -->
        <div id="sidebar"
            style="background-color: var(--background-color-base); box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1); border-right: 1px solid var(--border-color-muted);"
            class="h-full sidebar-transition relative">
            <div class="sidebar-content p-4 pt-16 space-y-6">
                <h2 class="text-heading-2">Filters</h2>

                <!-- Two-Step Project Selector -->
                <div id="projectSelector" class="relative">
                    <div class="project-selector-input-container">
                        <input type="text" id="projectSelectorInput" style="width: 100%; padding-right: 40px;"
                            placeholder="Search projects..." autocomplete="off">
                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                            <svg class="w-5 h-5" style="color: var(--color-muted);" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <div id="projectSelectorDropdown" class="project-selector-dropdown hidden">
                        <div class="project-selector-list" id="projectSelectorList"></div>
                    </div>
                </div>

                <div>
                    <label class="text-label block mb-2">Date Range</label>
                    <div id="dateRangeDisplay"
                        style="background-color: var(--background-color-neutral); border: 1px solid var(--border-color-base); border-radius: 2px; padding: 8px 12px; cursor: pointer; transition: background-color 0.1s ease, border-color 0.1s ease;"
                        class="text-body hover:bg-gray-100">
                        —</div>
                </div>

                <div class="space-y-2 hidden">
                    <label class="inline-flex items-center space-x-2 text-body">
                        <input id="filterEdits" type="checkbox" class="h-4 w-4"> <span>Filter Edits</span>
                    </label>
                    <label class="inline-flex items-center space-x-2 text-body">
                        <input id="filterUsers" type="checkbox" class="h-4 w-4"> <span>Filter Users</span>
                    </label>
                </div>

                <div>
                    <button id="submitButton" class="btn-primary w-full">Search</button>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="relative flex-1 p-6" style="background-color: var(--background-color-neutral);">
            <!-- Login/Logout Button -->
            {% if user %}
            <a href="{{ base_url }}/logout" class="btn-primary absolute top-6 right-6">
                Logout
            </a>
            {% else %}
            <a href="{{ base_url }}/login" class="btn-primary absolute top-6 right-6">
                Login
            </a>
            {% endif %}

            <!-- Centered Heading -->
            <div class="text-center mb-8">
                <h1 class="text-heading-1">Wikimedia Communities Activity Logs</h1>
            </div>

            <!-- No Data Message - placed below heading -->
            {% if not data and not chart %}
            <div class="text-center mb-8" style="color: var(--color-subtle);">
                <p class="text-body" style="font-size: 16px; margin-bottom: 8px;">No data available to display.</p>
                <p class="text-body-small">Please select a project and date range, then click Submit to view activity
                    data.</p>
            </div>
            {% endif %}

            <!-- Results Section -->
            {% if data %}
            <div class="mb-6">
                <h2 class="text-heading-2 mb-4">Detected Peaks</h2>
                <div style="background-color: var(--chart-background); border: 1px solid var(--border-color-muted); border-radius: 2px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);"
                    class="overflow-x-auto mb-8">
                    <table class="min-w-full">
                        <thead style="background-color: var(--background-color-neutral);">
                            <tr>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 500; color: var(--color-emphasized); border-bottom: 1px solid var(--border-color-muted);"
                                    class="text-label">Date</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 500; color: var(--color-emphasized); border-bottom: 1px solid var(--border-color-muted);"
                                    class="text-label">Edits</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 500; color: var(--color-emphasized); border-bottom: 1px solid var(--border-color-muted);"
                                    class="text-label">Rolling Mean</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 500; color: var(--color-emphasized); border-bottom: 1px solid var(--border-color-muted);"
                                    class="text-label">Threshold</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 500; color: var(--color-emphasized); border-bottom: 1px solid var(--border-color-muted);"
                                    class="text-label">% Diff</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 500; color: var(--color-emphasized); border-bottom: 1px solid var(--border-color-muted);"
                                    class="text-label">Label</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data %}
                            <tr style="border-bottom: 1px solid var(--border-color-muted);">
                                <td style="padding: 12px 16px; white-space: nowrap;" class="text-body">{{ row.timestamp
                                    }}</td>
                                <td style="padding: 12px 16px;" class="text-body">{{ row.edits }}</td>
                                <td style="padding: 12px 16px;" class="text-body">{{ row.rolling_mean }}</td>
                                <td style="padding: 12px 16px;" class="text-body">{{ row.threshold }}</td>
                                <td style="padding: 12px 16px;" class="text-body">{{ row.percentage_difference }}</td>
                                <td style="padding: 12px 16px;" class="text-body">{{ row.label or '' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Chart Section -->
            {% if chart %}
            <div class="mt-4" id="chartContainer"
                style="background-color: var(--chart-background); border: 1px solid var(--border-color-muted); border-radius: 2px; padding: 16px;">
                {{ chart|safe }}</div>
            {% endif %}
        </div>

        <!-- Button to toggle sidebar -->
        <button id="toggleSidebar"
            class="toggle-button absolute left-4 top-6 text-gray-700 hover:text-gray-900 transition-colors z-10">
            <span id="collapseIcon" class="block">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"
                    class="collapse-icon">
                    <path fill="currentColor" fill-rule="evenodd"
                        d="m7.29 11.29 4-4a1.004 1.004 0 0 1 1.42 1.42L10.41 11H19a1 1 0 1 1 0 2h-8.59l2.3 2.29a1 1 0 0 1 0 1.42 1 1 0 0 1-1.42 0l-4-4a1 1 0 0 1-.21-.33 1 1 0 0 1 0-.76 1 1 0 0 1 .21-.33ZM4 4a1 1 0 0 1 1 1v14a1 1 0 1 1-2 0V5a1 1 0 0 1 1-1Z"
                        clip-rule="evenodd" />
                </svg>
            </span>
            <span id="expandIcon" class="hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                    <path fill="currentColor" fill-rule="evenodd"
                        d="m15.71 11.29-4-4a1.004 1.004 0 0 0-1.42 1.42l2.3 2.29H4a1 1 0 1 0 0 2h8.59l-2.3 2.29a1 1 0 0 0 0 1.42 1 1 0 0 0 1.42 0l4-4a1 1 0 0 0 .21-.33 1 1 0 0 0 0-.76 1 1 0 0 0-.21-.33ZM19 4a1 1 0 0 0-1 1v14a1 1 0 1 0 2 0V5a1 1 0 0 0-1-1Z"
                        clip-rule="evenodd" />
                </svg>
            </span>
        </button>
    </div>

    <!-- Date Range Modal -->
    <div id="dateModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-[30rem] relative">
            <h3 class="text-xl font-bold mb-4">Select Date Range</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="startMonth" class="block text-xs font-medium text-gray-600 mb-1">Start</label>
                    <input type="month" id="startMonth" class="w-full border rounded px-2 py-2 text-sm" />
                </div>
                <div>
                    <label for="endMonth" class="block text-xs font-medium text-gray-600 mb-1">End</label>
                    <input type="month" id="endMonth" class="w-full border rounded px-2 py-2 text-sm" />
                </div>
            </div>
            <div class="mb-4 flex flex-wrap gap-2">
                <button class="quick-pick px-3 py-1.5 text-xs bg-gray-100 rounded hover:bg-gray-200"
                    data-range="3m">Last 3 mo</button>
                <button class="quick-pick px-3 py-1.5 text-xs bg-gray-100 rounded hover:bg-gray-200"
                    data-range="6m">Last 6 mo</button>
                <button class="quick-pick px-3 py-1.5 text-xs bg-gray-100 rounded hover:bg-gray-200"
                    data-range="12m">Last 12 mo</button>
                <button class="quick-pick px-3 py-1.5 text-xs bg-gray-100 rounded hover:bg-gray-200"
                    data-range="all">All</button>
                <button class="quick-pick px-3 py-1.5 text-xs bg-gray-100 rounded hover:bg-gray-200"
                    data-range="ytd">YTD</button>
            </div>
            <div class="flex justify-end space-x-2">
                <button id="closeDateModal" type="button" class="px-4 py-2 text-sm rounded border">Cancel</button>
                <button id="applyDateRange" type="button"
                    class="px-4 py-2 text-sm rounded bg-green-600 text-white hover:bg-green-700">Apply</button>
            </div>
        </div>
    </div>
    <script id="languages-data" type="application/json">{{ languages | tojson | safe }}</script>
    <script>
        // Parse languages data injected as JSON
        const rawLanguages = JSON.parse(document.getElementById('languages-data').textContent);

        // Elements
        const projectSelectorInput = document.getElementById('projectSelectorInput');
        const projectSelectorDropdown = document.getElementById('projectSelectorDropdown');
        const projectSelectorList = document.getElementById('projectSelectorList');
        const dateRangeDisplay = document.getElementById('dateRangeDisplay');
        const toggleSidebarButton = document.getElementById('toggleSidebar');
        const sidebar = document.getElementById('sidebar');
        const collapseIcon = document.getElementById('collapseIcon');
        const expandIcon = document.getElementById('expandIcon');
        const filterEdits = document.getElementById('filterEdits');
        const filterUsers = document.getElementById('filterUsers');
        const dateModal = document.getElementById('dateModal');
        const closeDateModalBtn = document.getElementById('closeDateModal');
        const applyDateRangeBtn = document.getElementById('applyDateRange');
        const startMonthInput = document.getElementById('startMonth');
        const endMonthInput = document.getElementById('endMonth');

        // Build projectData structure grouped by sitename with language list
        const projectData = {}; // { sitename: { name: readableName, languages: [{languageName, domain, url}] } }
        const projectNameMap = { wiki: 'Wikipedia', wiktionary: 'Wiktionary', wikibooks: 'Wikibooks', wikinews: 'Wikinews', wikiquote: 'Wikiquote', wikisource: 'Wikisource', wikiversity: 'Wikiversity', wikivoyage: 'Wikivoyage' };
        Object.entries(rawLanguages).forEach(([languageName, communities]) => {
            communities.forEach(c => {
                const key = c.sitename;
                if (!projectData[key]) projectData[key] = { name: projectNameMap[key] || key, languages: [] };
                try { const u = new URL(c.url); projectData[key].languages.push({ languageName, domain: u.hostname, url: c.url }); } catch { projectData[key].languages.push({ languageName, domain: c.url, url: c.url }); }
            });
        });

        let selectorState = { step: 'projects', selectedProject: null, selectedLanguage: null };

        function renderProjects(filter = '') {
            selectorState.step = 'projects';
            const entries = Object.entries(projectData).filter(([k, v]) => v.name.toLowerCase().includes(filter));
            projectSelectorList.innerHTML = entries.map(([key, proj]) => `<div class="project-selector-item" data-project="${key}"><div class="project-selector-item-main"><div class="project-selector-item-title">${proj.name}</div><div class="project-selector-item-subtitle">${proj.languages.length} languages</div></div><div class="project-selector-arrow">→</div></div>`).join('') || '<div class="project-selector-no-results">No projects</div>';
        }

        function renderLanguages(filter = '') {
            selectorState.step = 'languages';
            const proj = projectData[selectorState.selectedProject];
            let html = '<div class="project-selector-back"><span class="project-selector-back-arrow">←</span>Back</div>';
            const langs = proj.languages.filter(l => l.languageName.toLowerCase().includes(filter));
            html += langs.map(l => `<div class="project-selector-item" data-lang="${encodeURIComponent(l.languageName)}" data-domain="${l.domain}" data-url="${l.url}"><div class="project-selector-item-main"><div class="project-selector-item-title">${l.languageName}</div><div class="project-selector-item-subtitle">${proj.name}</div></div></div>`).join('') || '<div class="project-selector-no-results">No languages</div>';
            projectSelectorList.innerHTML = html;
        }

        function openDropdown() { projectSelectorDropdown.classList.remove('hidden'); }
        function closeDropdown() { projectSelectorDropdown.classList.add('hidden'); }

        projectSelectorInput.addEventListener('click', (e) => {
            e.stopPropagation();
            if (projectSelectorDropdown.classList.contains('hidden')) {
                openDropdown();
                if (selectorState.step === 'projects') renderProjects(projectSelectorInput.value.toLowerCase());
                else renderLanguages(projectSelectorInput.value.toLowerCase());
            }
        });
        projectSelectorInput.addEventListener('focus', () => {
            if (projectSelectorDropdown.classList.contains('hidden')) {
                openDropdown();
                if (selectorState.step === 'projects') renderProjects(projectSelectorInput.value.toLowerCase());
                else renderLanguages(projectSelectorInput.value.toLowerCase());
            }
        });
        projectSelectorInput.addEventListener('input', e => {
            const val = e.target.value.toLowerCase();
            if (projectSelectorDropdown.classList.contains('hidden')) {
                openDropdown();
            }
            if (selectorState.step === 'projects') renderProjects(val);
            else renderLanguages(val);
        });
        document.addEventListener('click', e => {
            if (!document.getElementById('projectSelector').contains(e.target)) closeDropdown();
        });
        projectSelectorList.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();
            const item = e.target.closest('.project-selector-item');
            if (!item) {
                if (e.target.closest('.project-selector-back')) {
                    selectorState.selectedProject = null;
                    projectSelectorInput.value = '';
                    projectSelectorInput.placeholder = 'Search projects...';
                    renderProjects();
                }
                return;
            }
            if (selectorState.step === 'projects') {
                selectorState.selectedProject = item.dataset.project;
                projectSelectorInput.value = '';
                projectSelectorInput.placeholder = 'Search languages...';
                // Keep dropdown open and render languages
                renderLanguages();
                // Keep focus on input
                projectSelectorInput.focus();
            }
            else if (selectorState.step === 'languages') {
                selectorState.selectedLanguage = decodeURIComponent(item.dataset.lang);
                selectorState.domain = item.dataset.domain;
                projectSelectorInput.value = `${projectData[selectorState.selectedProject].name} – ${selectorState.selectedLanguage}`;
                // Only close dropdown when final selection is made
                closeDropdown();
            }
        });

        // Sidebar toggle
        toggleSidebarButton.addEventListener('click', () => {
            const collapsed = sidebar.classList.toggle('sidebar-collapsed');
            collapseIcon.classList.toggle('hidden', collapsed);
            expandIcon.classList.toggle('hidden', !collapsed);
        });

        // Date handling
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        function formatDisplayRange() {
            if (!startMonthInput.value || !endMonthInput.value) { dateRangeDisplay.textContent = '—'; return; }
            const [sY, sM] = startMonthInput.value.split('-').map(Number);
            const [eY, eM] = endMonthInput.value.split('-').map(Number);
            dateRangeDisplay.textContent = `${monthNames[sM - 1]} ${sY} → ${monthNames[eM - 1]} ${eY}`;
        }

        dateRangeDisplay.addEventListener('click', () => { dateModal.classList.remove('hidden'); });
        closeDateModalBtn.addEventListener('click', () => { dateModal.classList.add('hidden'); });
        applyDateRangeBtn.addEventListener('click', () => { formatDisplayRange(); dateModal.classList.add('hidden'); });

        document.querySelectorAll('.quick-pick').forEach(btn => {
            btn.addEventListener('click', () => {
                const now = new Date();
                let start;
                const range = btn.dataset.range;
                if (range === 'all') { start = new Date(2014, 0, 1); }
                else if (range === 'ytd') { start = new Date(now.getFullYear(), 0, 1); }
                else if (/m$/.test(range)) { const months = parseInt(range.slice(0, -1), 10); start = new Date(now.getFullYear(), now.getMonth() - (months - 1), 1); }
                else { start = new Date(now.getFullYear(), now.getMonth(), 1); }
                const end = new Date(now.getFullYear(), now.getMonth(), 1);
                startMonthInput.value = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, '0')}`;
                endMonthInput.value = `${end.getFullYear()}-${String(end.getMonth() + 1).padStart(2, '0')}`;
                formatDisplayRange();
            });
        });

        // Submit/search
        document.getElementById('submitButton').addEventListener('click', () => {
            if (!selectorState.selectedProject || !selectorState.selectedLanguage || !selectorState.domain) { alert('Select a project and language first.'); return; }
            if (!startMonthInput.value || !endMonthInput.value) { alert('Select date range'); return; }
            const [startY, startM] = startMonthInput.value.split('-').map(Number);
            const [endY, endM] = endMonthInput.value.split('-').map(Number);
            const datestart = `${monthNames[startM - 1]} ${startY}`;
            const dateend = `${monthNames[endM - 1]} ${endY}`;
            const language = selectorState.selectedLanguage; // using language name
            const project_group = encodeURIComponent(`${language}:/${selectorState.domain}`);
            const params = new URLSearchParams({ language, project_group, datestart, dateend, filter_edits: filterEdits.checked, filter_users: filterUsers.checked });
            window.location.search = params.toString();
        });

        (function init() {
            renderProjects();
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth() - 11, 1);
            startMonthInput.value = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, '0')}`;
            endMonthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            formatDisplayRange();
            const qs = new URLSearchParams(window.location.search);
            if (qs.get('language') && qs.get('project_group')) {
                const language = qs.get('language');
                const pg = decodeURIComponent(qs.get('project_group'));
                const domain = pg.split(':/')[1];
                // Find the project containing this domain
                Object.entries(projectData).forEach(([projKey, proj]) => {
                    const langEntry = proj.languages.find(l => l.languageName === language && l.domain === domain);
                    if (langEntry) {
                        selectorState.selectedProject = projKey;
                        selectorState.selectedLanguage = language;
                        selectorState.domain = domain;
                        projectSelectorInput.value = `${proj.name} – ${language}`;
                    }
                });
            }
            if (qs.get('datestart') && qs.get('dateend')) { const ds = qs.get('datestart').split(' '); const de = qs.get('dateend').split(' '); const sm = monthNames.indexOf(ds[0]) + 1; const em = monthNames.indexOf(de[0]) + 1; if (sm > 0 && em > 0) { startMonthInput.value = `${ds[1]}-${String(sm).padStart(2, '0')}`; endMonthInput.value = `${de[1]}-${String(em).padStart(2, '0')}`; formatDisplayRange(); } }
            filterEdits.checked = qs.get('filter_edits') === 'true';
            filterUsers.checked = qs.get('filter_users') === 'true';
        })();
    </script>
</body>

</html>